name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Run typecheck
        run: bun typecheck

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Run lint
        run: bun lint

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Run unit tests
        run: bun unit

  component:
    name: Component Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Install Cypress system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2 libxtst6 xauth xvfb
      - name: Run component tests
        run: bun component

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_CONVEX_URL: ${{ secrets.TEST_NEXT_PUBLIC_CONVEX_URL }}
      CONVEX_URL: ${{ secrets.TEST_NEXT_PUBLIC_CONVEX_URL }}
      CONVEX_DEPLOY_KEY: ${{ secrets.TEST_CONVEX_DEPLOY_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Install Cypress system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2 libxtst6 xauth xvfb
      - name: Create .env.test.local
        run: |
          echo "NEXT_PUBLIC_CONVEX_URL=${{ secrets.TEST_NEXT_PUBLIC_CONVEX_URL }}" >> .env.test.local
          echo "CONVEX_URL=${{ secrets.TEST_NEXT_PUBLIC_CONVEX_URL }}" >> .env.test.local
          echo "CONVEX_DEPLOY_KEY=${{ secrets.TEST_CONVEX_DEPLOY_KEY }}" >> .env.test.local
      - name: Start Next.js dev server
        run: bun dev:frontend &
      - name: Wait for Next.js to be ready
        run: timeout 60 bash -c 'until curl -sf http://localhost:6604 > /dev/null; do sleep 2; done'
      - name: Run integration tests
        run: bun integration
