name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      CYPRESS_OTP_OVERRIDE: 12345678
      GOOGLE_AI_API_KEY: test-key
      STUB_APIS: 'true'
      NEXT_PUBLIC_CONVEX_URL: ${{ secrets.TEST_NEXT_PUBLIC_CONVEX_URL }}
      CONVEX_URL: ${{ secrets.TEST_NEXT_PUBLIC_CONVEX_URL }}
      CONVEX_DEPLOY_KEY: ${{ secrets.TEST_CONVEX_DEPLOY_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Typecheck
        run: bun typecheck
      - name: Lint
        run: bun lint
      - name: Unit tests
        run: bun unit
      - name: Component tests
        uses: cypress-io/github-action@v6
        with:
          install: false
          component: true
          command: bunx cypress run --component
      - name: Integration tests
        uses: cypress-io/github-action@v6
        with:
          install: false
          start: bun dev:frontend
          wait-on: http://localhost:6604
          command: bunx cypress run
